calculate_magic_research = {
	if = {
		limit = {
			is_magic_country = yes
		}
		# Mage Gate Innovation
		set_variable = {
			name = weekly_magic_innovation_magic_gate
			value = {
				value = 0
				every_scope_building = {
					limit = {
						is_building_type = building_gate
					}
					add = 10
				}
			}
		}

		# Mage Tower Innovation
		set_variable = {
			name = weekly_magic_innovation_mage_tower
			value = {
				value = 0
				every_scope_building = {
					limit = {
						is_building_type = building_mage_tower
					}
					add = 5
				}
			}
		}

		# Magic Academy Innovation
		set_variable = {
			name = weekly_magic_innovation_magic_academy
			value = {
				value = 0
				every_scope_building = {
					limit = {
						is_building_type = building_magic_academy
					}
					add = 20
				}
			}
		}

		# University Innovation
		set_variable = {
			name = weekly_magic_innovation_university
			value = {
				value = 0
				every_scope_building = {
					limit = {
						is_building_type = building_university
					}
					if = {
						limit = {
							has_active_production_method = pm_university_simple_magic_research
						}
						add = {
							value = 2
							multiply = level
						}
					}
					else_if = {
						limit = {
							has_active_production_method = pm_university_advanced_magic_research
						}
						add = {
							value = 4
							multiply = level
						}
					}
				}
			}
		}

		# Total Innovation
		set_variable = {
			name = weekly_magic_innovation
			value = {
				value = global_var:weekly_magic_innovation_base
				add = var:weekly_magic_innovation_magic_gate
				add = var:weekly_magic_innovation_mage_tower
				add = var:weekly_magic_innovation_magic_academy
				add = var:weekly_magic_innovation_university
			}
		}

		if = {
			limit = {
				has_variable = magic_research
				has_variable = magic_research_progress
			}
			change_variable = {
				name = magic_research_progress
				add = {
					value = var:weekly_magic_innovation
					multiply = 4
				}
			}
		}
	}
}

remove_magic_research = {
	remove_variable = magic_research
	remove_variable = magic_research_progress
}

# Research Institutes can only exist in capital states
cleanup_research_institutes = {
	every_state = {
		limit = {
			is_capital = no
			has_building = building_magic_research_institute
		}
		remove_building = building_magic_research_institute
	}
}