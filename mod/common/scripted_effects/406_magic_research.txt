calculate_magic_research = {
	if = {
		limit = {
			is_magic_country = yes
		}

		# Total Innovation
		set_variable = {
			name = monthly_magic_innovation
			value = modifier:country_magical_innovation_add
		}

		# Banking
		change_variable = {
			name = magic_innovation
			add = modifier:country_magical_innovation_add
		}

		clamp_variable = {
			name = magic_innovation
			max = global_var:magic_innovation_bank_max
		}
	}
}

# Research Institutes can only exist in capital states
cleanup_research_institutes = {
	every_state = {
		limit = {
			is_capital = no
			has_building = building_magic_research_institute
		}
		remove_building = building_magic_research_institute
	}
}

reset_research_institute_pm = {
	if = {
		limit = {
			capital = {
				has_building = building_magic_research_institute
			}
		}
		if = {
			limit = {
				NOT = {
					has_variable = magic_researcher
				}
			}
			activate_production_method = {
				building_type = building_magic_research_institute
				production_method = pm_no_researcher
			}
		}
		else_if = {
			limit = {
				var:magic_researcher = {
					has_variable = magic_experience
					var:magic_experience >= character_master_threshhold
				}
			}
			activate_production_method = {
				building_type = building_magic_research_institute
				production_method = pm_archmage_researcher
			}
		}
		else_if = {
			limit = {
				var:magic_researcher = {
					has_variable = magic_experience
					var:magic_experience >= character_experienced_threshhold
				}
			}
			activate_production_method = {
				building_type = building_magic_research_institute
				production_method = pm_experienced_researcher
			}
		}
		else = {
			activate_production_method = {
				building_type = building_magic_research_institute
				production_method = pm_novice_researcher
			}
		}
	}
}

make_magic_researcher_busy = {
	var:magic_researcher = {
		set_character_busy_and_immortal = yes
		set_variable = {
			name = com_opinion
			value = flag:character_opinion_magic_researcher_busy
		}
	}
}

make_magic_researcher_not_busy = {
	var:magic_researcher = {
		set_character_busy_and_immortal = no
		set_variable = {
			name = com_opinion
			value = flag:character_opinion_magic_researcher
		}
	}
}

cleanup_researchers = {
	if = {
		limit = {
			has_variable = magic_researcher
			NOT = {
				exists = var:magic_researcher
			}
		}
		if = {
			limit = {
				has_journal_entry = je_researching_magic
			}
			je:je_researching_magic = {
				clear_variable_list = com_journal_characters
			}
		}
		activate_production_method = {
			building_type = building_magic_research_institute
			production_method = pm_no_researcher
		}
		remove_variable = magic_researcher
	}
	else_if = {
		limit = {
			has_variable = magic_researcher
			exists = var:magic_researcher
		}
		if = {
			limit = {
				var:magic_researcher = {
					is_character_alive = no
				}
			}
			if = {
				limit = {
					has_journal_entry = je_researching_magic
				}
				je:je_researching_magic = {
					remove_list_variable = {
						name = com_journal_characters
						target = var:magic_researcher
					}
				}
			}
			activate_production_method = {
				building_type = building_magic_research_institute
				production_method = pm_no_researcher
			}
			remove_variable = magic_researcher
		}
	}
}