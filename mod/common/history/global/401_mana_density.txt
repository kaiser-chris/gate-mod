# This scripts are run after all other history scripts were run
GLOBAL = {

	# Get amount of states for
	# later calculation
	set_global_variable = {
		name = state_count
		value = 0
	}
	every_state_region = {
		change_global_variable = {
			name = state_count
			add = 1
		}
	}

	every_state_region = {
		set_variable = {
			name = mana_density
			value = 0
		}
	}

	# Build initial Mana Density around gates
	every_state = {
		limit = {
			has_building = building_gate
		}
		state_region = {
			set_variable = {
				name = mana_density
				value = 100
			}
		}
		every_neighbouring_state = {
			limit = {
				state_region = {
					var:mana_density < 100
				}
			}
			state_region = {
				set_variable = {
					name = mana_density
					value = 70
				}
			}
			every_neighbouring_state = {
				limit = {
					state_region = {
						var:mana_density < 70
					}
				}
				state_region = {
					set_variable = {
						name = mana_density
						value = 40
					}
				}
				every_neighbouring_state = {
					limit = {
						state_region = {
							var:mana_density < 40
						}
					}
					state_region = {
						set_variable = {
							name = mana_density
							value = 10
						}
					}
				}
			}
		}
	}

	# Mana Density Cache
	set_global_variable = {
		name = global_mana_density_cache
		value = {
			value = 0
			every_state_region = {
				limit = {
					var:mana_density > 0
				}
				add = var:mana_density
			}
		}
	}

	# Randomly propagate mana density
	# so every start is a little different
	random = {
		chance = 50
		propogate_mana_density = yes
	}
	random = {
		chance = 50
		propogate_mana_density = yes
	}
	random = {
		chance = 50
		propogate_mana_density = yes
	}
	random = {
		chance = 50
		propogate_mana_density = yes
	}

	# After random propagation calculate saturation
	calculate_mana_saturation = yes
}
